---
title: "Lecture9.18"
output: github_document
---

```{r results='hide', message=FALSE}
library(readr)
library(tidyverse)
library(readxl)
library(haven)
```

# Data Manipulation

First, import the data set & clean the variable names.

```{r collapse=TRUE, results='hide', message=FALSE}
litters_df = read_csv("../../data_import_examples/FAS_litters.csv", na = c("NA", ".", ""))
litters_df = janitor::clean_names(litters_df)
names(litters_df)
```

## `select` variables from dataframe

We apply `select` on **columns**.

-   select specific columns

```{r results='hide'}
select(litters_df, group, litter_number, gd0_weight)
```

-   select a range of columns

```{r results='hide'}
select(litters_df, group:gd_of_birth)
```

-   select by remove certain columns

```{r results='hide'}
select(litters_df, -group, -litter_number, -gd0_weight)
select(litters_df, -(group:gd_of_birth))
```

-   select by prefix

```{r results='hide'}
select(litters_df, group, starts_with("gd"))
```

-   select by suffix

```{r results='hide'}
select(litters_df, group, contains("gd"))
```

-   rearrange by selecting

```{r results='hide'}
select(litters_df, starts_with("gd"), group)
select(litters_df, litter_number, everything()) 
```

put `litternumber` piror to else, same to

```{r results='hide'}
relocate(litters_df, litter_number)
```

-   rename by selecting

```{r results='hide'}
#rename group variable
select(litters_df, GROUP = group, everything())
rename(litters_df, GROUP = group) # same function
```

## `filter`

We use `filter` to filter out **rows**.

-   `filter` will turn rows that return **TRUE** to all conditions

```{r results='hide'}
filter(litters_df, gd_of_birth == 20, pups_born_alive >= 6, pups_dead_birth <= 0)
```

-   filter for non-matches

```{r results='hide'}
filter(litters_df, pups_born_alive !=6)
```

-   match to a set {}

```{r results='hide'}
# return group that in Condition7 and Condition8
filter(litters_df, group %in% c("Con7", "Con8"))
```

-   `filter` out missing rows with `drop_na()`

```{r results='hide'}
drop_na(litters_df) #for the entire data set
drop_na(litters_df, gd0_weight) #for specific rows
```

# `mutate`

We use `mutate()` to create or modify variables.

-   create new variables
-   make (modify) variable lowercase

```{r results='hide'}
mutate(
  litters_df, 
  wt_gain = gd18_weight - gd0_weight,
  group = str_to_lower(group)
) #Con --> con
```

# `arrange`

```{r results='hide'}
# rank group first, then pups_born_alive from lowest to highest
arrange(litters_df, group, pups_born_alive)
arrange(litters_df, desc(group), pups_born_alive)
```

# PIPES

-   pipes put the `select`,`filter`,`mutate` and `arrange` together.

Some bad examples will be:

```{r results='hide', message=FALSE}
# Too confused
litters_df_raw = read_csv("../../data_import_examples/FAS_litters.csv", na = c("NA", ".", ""))
litters_df_clean_names = janitor::clean_names(litters_df_raw)
litters_df_selected_cols = select(litters_df_clean_names, -pups_survive)
litters_df_with_vars = 
  mutate(
    litters_df_selected_cols, 
    wt_gain = gd18_weight - gd0_weight,
    group = str_to_lower(group))
litters_df_with_vars_without_missing = 
  drop_na(litters_df_with_vars, wt_gain)
litters_df_with_vars_without_missing
```

OR

```{r results='hide', message=FALSE}
# Has to be read inside
litters_df_clean = 
  drop_na(
    mutate(
      select(
        janitor::clean_names(
          read_csv("../../data_import_examples/FAS_litters.csv", na = c("NA", ".", ""))
          ), 
      -pups_survive
      ),
    wt_gain = gd18_weight - gd0_weight,
    group = str_to_lower(group)
    ),
  wt_gain
  )
```

We use pipes to avoid all these: pipes **pass the result** of the previous function to the next function

```{r results='hide', message=FALSE}
litters_df = 
  read_csv("../../data_import_examples/FAS_litters.csv", na = c("NA", ".", "")) |> 
  janitor::clean_names() |> 
  select(-pups_survive) |> 
  mutate(
    wt_gain = gd18_weight - gd0_weight,
    group = str_to_lower(group)) |> 
  drop_na(wt_gain)
```

# Lecture 9.23 (Tidy Data)

## Pivot Longer 合并columns

```{r}
pulse_df = 
  read_sas("../../data_import_examples/public_pulse_data.sas7bdat") |>
  janitor::clean_names() |>
  pivot_longer(
    cols = bdi_score_bl:bdi_score_12m, #from column A to column B, cols = A:B
    names_to = "visit", #combine cols into one column named 'visit'
    values_to = "bdi_score", #attribute the values to this new column named 'bdi_score'
    names_prefix = "bdi_score_") |> #delete strings in the one column
  mutate(visit = replace(visit, visit == "bl", "00m")) |> #be consistent about the unit
  relocate(id, visit)
#replace(): replace(a, condition, b), replace a to b if qualifies the condition
```

Another example:

```{r}
litters_df2 = 
  read_csv("../../data_import_examples/FAS_litters.csv", na = c("NA",".","")) |>
  janitor::clean_names() |>
  # then we combine gd0_weight and gd18_weight 
  pivot_longer(
    cols = gd0_weight:gd18_weight,
    names_to = "gd_time", 
    values_to = "weight") |>
  # change gd0_weight to 0, vice versa
  mutate(gd_time = case_match(
    gd_time,
    "gd0_weight" ~ 0,
    "gd18_weight" ~ 18
  ))
        
```

## Pivot Wider 拆分成多个columns

First we create a table.

```{r}
analysis_df = 
  tibble(group = c("treatment", "treatment", "control", "control"),
         time = c("pre", "post", "pre", "post"),
         mean = c(4, 10, 4.2, 5))
View(analysis_df)
```

Now we clean this dataframe.

```{r}
analysis_df |>
  pivot_wider(
    # create new names
    names_from = time,
    values_from = mean
  ) |>
  # produce output for visualization
  knitr::kable()
```

## Binding Tables

Use this when we have multiple datasets

```{r}
fellowship_ring_original = 
  read_excel("../../data_import_examples/LotR_Words.xlsx")
View(fellowship_ring_original)

fellowship_ring = 
  read_excel("../../data_import_examples/LotR_Words.xlsx", range = "B3:D6") |>
  mutate(movie = "fellowship_ring")

two_towers = 
  read_excel("../../data_import_examples/LotR_Words.xlsx", range = "F3:H6") |>
  mutate(movie = "two_towers")

return_of_king = 
  read_excel("../../data_import_examples/LotR_Words.xlsx", range = "J3:L6") |>
  mutate(movie = "return_of_king")

lotr.df_nogender = 
  bind_rows(fellowship_ring, two_towers, return_of_king)
View(lotr.df_nogender)

lotr.df_gender = 
  bind_rows(fellowship_ring, two_towers, return_of_king) |>
  janitor::clean_names() |>
  pivot_longer(
    cols = female:male,
    names_to = "sex",
    values_to = "words"
  ) |>
  relocate(movie, race, sex, words) |>
  # convert to lowercase
  mutate(race = str_to_lower(race))
View(lotr.df_gender)

```

## Joining dataset

Import `litters` dataset

```{r}
litters_df3 = 
  read_csv("../../data_import_examples/FAS_litters.csv", na = c("NA",".","")) |>
  janitor::clean_names() |>
  mutate(wt_gain = gd18_weight - gd0_weight) |>
  # separate GROUP into DOSE and DAYOFTREATMENT, separate from the 3rd index
  separate(
    group, into = c("dose", "day_of_treatment"), sep = 3
  )

View(litters_df3)
```

Import`pups` next!

```{r}

```

Join the datasets!
